<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/base}">
<head>
    <title>My Borrowings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<div layout:fragment="content">
    <div class="container">
        <h1>My Borrowings</h1>

        <form id="searchForm" class="mb-3">
            <div class="row g-3">
                <div class="col-auto">
                    <input oninput="searchBorrowings()" type="text" id="searchInput" name="search" class="form-control"
                           placeholder="Search by book title..."
                           aria-label="Search">
                </div>

                <div class="col-auto">
                    <select id="statusFilter" name="status" class="form-select" onchange="filterByStatus()">
                        <option value="">All</option>
                        <option value="RETURNED">Returned</option>
                        <option value="NOT_RETURNED">Not Returned</option>
                        <option value="OVERDUE">Overdue</option>
                    </select>
                </div>
            </div>
        </form>

        <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

        <div id="loadingSpinner" style="display: none;" class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <div id="tableContainer">
            <table class="table table-bordered">
                <thead>
                <tr>
                    <th>
                        <a href="javascript:void(0)" onclick="sortTable('id')">
                            ID
                            <span id="sort-id-asc" style="display: none;">▲</span>
                            <span id="sort-id-desc" style="display: none;">▼</span>
                        </a>
                    </th>
                    <th>
                        <a href="javascript:void(0)" onclick="sortTable('book.title')">
                            Book
                            <span id="sort-book.title-asc" style="display: none;">▲</span>
                            <span id="sort-book.title-desc" style="display: none;">▼</span>
                        </a>
                    </th>
                    <th>
                        <a href="javascript:void(0)" onclick="sortTable('borrowDate')">
                            Borrow date
                            <span id="sort-borrowDate-asc" style="display: none;">▲</span>
                            <span id="sort-borrowDate-desc" style="display: none;">▼</span>
                        </a>
                    </th>
                    <th>
                        <a href="javascript:void(0)" onclick="sortTable('returnDate')">
                            Return date
                            <span id="sort-returnDate-asc" style="display: none;">▲</span>
                            <span id="sort-returnDate-desc" style="display: none;">▼</span>
                        </a>
                    </th>
                    <th>
                        <a href="javascript:void(0)" onclick="sortTable('dueDate')">
                            Due date
                            <span id="sort-dueDate-asc" style="display: none;">▲</span>
                            <span id="sort-dueDate-desc" style="display: none;">▼</span>
                        </a>
                    </th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody id="borrowingTableBody">
                <!-- Table rows will be populated by AJAX -->
                </tbody>
            </table>
        </div>

        <div id="paginationContainer">
            <!-- Pagination will be populated by AJAX -->
        </div>

        <div id="noResults" class="text-center text-muted" style="display: none;">No results found.</div>

        <script>
            let currentPage = 0;
            let currentSize = 5;
            let currentSearch = '';
            let currentStatus = '';
            let currentSort = '';

            document.addEventListener('DOMContentLoaded', function() {
                loadBorrowings();
            });

            function loadBorrowings(page = currentPage, size = currentSize, search = currentSearch, status = currentStatus, sort = currentSort) {
                document.getElementById('loadingSpinner').style.display = 'block';
                document.getElementById('tableContainer').style.display = 'none';

                const params = new URLSearchParams();
                if (page !== null) params.append('page', page);
                if (size !== null) params.append('size', size);
                params.append('search', search || '');
                if (status) params.append('status', status);
                if (sort) params.append('sort', sort);

                // API endpoint cho my-borrowings
                fetch('/api/my-borrowings?' + params.toString())
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        currentPage = data.currentPage;
                        currentSize = data.size;
                        currentSearch = data.search || '';
                        currentStatus = data.status || '';
                        currentSort = data.sort || '';

                        updateTable(data.borrowings);
                        updatePagination(data);
                        updateSortIndicators();

                        document.getElementById('loadingSpinner').style.display = 'none';
                        document.getElementById('tableContainer').style.display = 'block';
                        document.getElementById('noResults').style.display = data.borrowings.length === 0 ? 'block' : 'none';
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        document.getElementById('errorMessage').textContent = 'Failed to load data: ' + error.message;
                        document.getElementById('errorMessage').style.display = 'block';
                        document.getElementById('loadingSpinner').style.display = 'none';
                    });
            }

            function searchBorrowings() {
                const searchValue = document.getElementById('searchInput').value;
                loadBorrowings(0, currentSize, searchValue, currentStatus, currentSort);
            }

            function filterByStatus() {
                const statusValue = document.getElementById('statusFilter').value;
                const searchValue = currentSearch || '';
                loadBorrowings(0, currentSize, searchValue, statusValue, currentSort);
            }

            function sortTable(field) {
                let newSort = field + ',asc';
                if (currentSort && currentSort.startsWith(field)) {
                    if (currentSort.endsWith('asc')) {
                        newSort = field + ',desc';
                    } else {
                        newSort = field + ',asc';
                    }
                }
                loadBorrowings(currentPage, currentSize, currentSearch, currentStatus, newSort);
            }

            function goToPage(page) {
                loadBorrowings(page, currentSize, currentSearch, currentStatus, currentSort);
            }

            function updateTable(borrowings) {
                const tbody = document.getElementById('borrowingTableBody');
                tbody.innerHTML = '';

                borrowings.forEach(borrowing => {
                    // Determine status
                    let statusBadge = '';
                    if (borrowing.returnDate) {
                        statusBadge = '<span class="badge bg-success">Returned</span>';
                    } else if (borrowing.dueDate && new Date(borrowing.dueDate) < new Date()) {
                        statusBadge = '<span class="badge bg-danger">Overdue</span>';
                    } else {
                        statusBadge = '<span class="badge bg-warning">Not Returned</span>';
                    }

                    const row = `
                        <tr>
                            <td>${borrowing.id}</td>
                            <td>${borrowing.bookTitle}</td>
                            <td>${borrowing.borrowDate}</td>
                            <td>${borrowing.returnDate || 'Not returned'}</td>
                            <td>${borrowing.dueDate || 'No due date'}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            function updatePagination(data) {
                const container = document.getElementById('paginationContainer');
                if (data.totalPages <= 1) {
                    container.innerHTML = '';
                    return;
                }

                let paginationHtml = `
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            <li class="page-item ${data.currentPage === 0 ? 'disabled' : ''}">
                                <a class="page-link" href="javascript:void(0)" onclick="goToPage(${data.currentPage - 1})">Previous</a>
                            </li>
                `;

                for (let i = 0; i < data.totalPages; i++) {
                    paginationHtml += `
                        <li class="page-item ${i === data.currentPage ? 'active' : ''}">
                            <a class="page-link" href="javascript:void(0)" onclick="goToPage(${i})">${i + 1}</a>
                        </li>
                    `;
                }

                paginationHtml += `
                            <li class="page-item ${data.currentPage + 1 >= data.totalPages ? 'disabled' : ''}">
                                <a class="page-link" href="javascript:void(0)" onclick="goToPage(${data.currentPage + 1})">Next</a>
                            </li>
                        </ul>
                        <p class="text-center text-muted">Total items: ${data.totalItems}</p>
                    </nav>
                `;

                container.innerHTML = paginationHtml;
            }

            function updateSortIndicators() {
                document.querySelectorAll('[id^="sort-"]').forEach(el => el.style.display = 'none');
                if (currentSort) {
                    const [field, direction] = currentSort.split(',');
                    const indicator = document.getElementById(`sort-${field}-${direction}`);
                    if (indicator) {
                        indicator.style.display = 'inline';
                    }
                }
            }

            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchBorrowings();
                }
            });
        </script>
    </div>
</div>
</html>