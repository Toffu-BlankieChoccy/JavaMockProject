<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/base}">
<head>
    <title>Borrowing List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<div layout:fragment="content">
    <div class="container">
        <h1>Borrowings</h1>

        <!-- Search and Filter Form -->
        <form id="searchForm" class="mb-3">
            <div class="row g-3">
                <div class="col-auto">
                    <input oninput="searchBorrowings()" type="text" id="searchInput" name="search" class="form-control"
                           placeholder="Search by user name or book title..."
                           th:value="${search}" aria-label="Search">
                </div>
                <div class="col-auto">
                    <select id="statusFilter" name="status" class="form-select" onchange="filterByStatus()">
                        <option value="">All</option>
                        <option value="RETURNED">Returned</option>
                        <option value="NOT_RETURNED">Not Returned</option>
                        <option value="OVERDUE">Overdue</option>
                    </select>
                </div>
            </div>
        </form>

        <a th:href="@{/borrowings/add}" class="btn btn-primary mb-3">Add New Borrowing</a>

        <!-- Error Message -->
        <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>


        <!-- Table Container -->
        <div id="tableContainer">
            <table class="table table-bordered">
                <thead>
                <tr>
                    <th><a href="javascript:void(0)" onclick="sortTable('id')">ID <span id="sort-id-asc"
                                                                                        style="display: none;">▲</span><span
                            id="sort-id-desc" style="display: none;">▼</span></a></th>
                    <th><a href="javascript:void(0)" onclick="sortTable('book.title')">Book <span
                            id="sort-book.title-asc" style="display: none;">▲</span><span id="sort-book.title-desc"
                                                                                          style="display: none;">▼</span></a>
                    </th>
                    <th><a href="javascript:void(0)" onclick="sortTable('user.name')">User <span id="sort-user.name-asc"
                                                                                                 style="display: none;">▲</span><span
                            id="sort-user.name-desc" style="display: none;">▼</span></a></th>
                    <th><a href="javascript:void(0)" onclick="sortTable('borrowDate')">Borrow Date <span
                            id="sort-borrowDate-asc" style="display: none;">▲</span><span id="sort-borrowDate-desc"
                                                                                          style="display: none;">▼</span></a>
                    </th>
                    <th><a href="javascript:void(0)" onclick="sortTable('returnDate')">Return Date <span
                            id="sort-returnDate-asc" style="display: none;">▲</span><span id="sort-returnDate-desc"
                                                                                          style="display: none;">▼</span></a>
                    </th>
                    <th><a href="javascript:void(0)" onclick="sortTable('dueDate')">Due Date <span id="sort-dueDate-asc"
                                                                                                   style="display: none;">▲</span><span
                            id="sort-dueDate-desc" style="display: none;">▼</span></a></th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="borrowingTableBody">
                <!-- Table rows populated by AJAX -->
                </tbody>
            </table>
        </div>
        <!-- Loading Spinner -->
        <div id="loadingSpinner" style="display: none;" class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Pagination Container -->
        <div id="paginationContainer"></div>

        <!-- No Results Message -->
        <div id="noResults" class="text-center text-muted" style="display: none;">No results found.</div>
    </div>

    <script>
        // Global state variables
        let currentPage = 0;
        let currentSize = 5;
        let currentSearch = '';
        let currentStatus = '';
        let currentSort = '';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Get initial values from Thymeleaf
            currentPage = parseInt('[[${currentPage}]]') || 0;
            currentSize = parseInt('[[${size}]]') || 5;
            currentSearch = '[[${search}]]' || '';
            currentStatus = '[[${status}]]' || '';
            currentSort = '[[${sort}]]' || '';

            // Set form values
            document.getElementById('searchInput').value = currentSearch;
            document.getElementById('statusFilter').value = currentStatus;

            // Load initial data
            updateSortIndicators();
            loadBorrowings();

            // Add Enter key listener for search
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchBorrowings();
                }
            });
        });

        // Main function to load borrowings
        function loadBorrowings(page = currentPage, size = currentSize, search = currentSearch, status = currentStatus, sort = currentSort) {
            showLoading();

            const params = new URLSearchParams();
            if (page !== null && page !== undefined) params.append('page', page);
            if (size !== null && size !== undefined) params.append('size', size);
            if (search) params.append('search', search);
            if (status) params.append('status', status);
            if (sort) params.append('sort', sort);

            fetch('/api/borrowings?' + params.toString())
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    // Update global state
                    currentPage = data.currentPage;
                    currentSize = data.size;
                    currentSearch = data.search || '';
                    currentStatus = data.status || '';
                    currentSort = data.sort || '';

                    // Update UI
                    updateTable(data.borrowings);
                    updatePagination(data);
                    updateSortIndicators();
                    hideLoading();

                    // Show/hide no results
                    document.getElementById('noResults').style.display = data.borrowings.length === 0 ? 'block' : 'none';
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('Failed to load borrowings data');
                    hideLoading();
                });
        }

        // Search function
        function searchBorrowings() {
            const searchValue = document.getElementById('searchInput').value.trim();
            loadBorrowings(0, currentSize, searchValue, currentStatus, currentSort);
        }

        // Filter function
        function filterByStatus() {
            const statusValue = document.getElementById('statusFilter').value;
            loadBorrowings(0, currentSize, currentSearch, statusValue, currentSort);
        }

        // Sort function
        function sortTable(field) {
            let newSort = field + ',asc';
            if (currentSort && currentSort.startsWith(field)) {
                newSort = currentSort.endsWith('asc') ? field + ',desc' : field + ',asc';
            }
            loadBorrowings(currentPage, currentSize, currentSearch, currentStatus, newSort);
        }

        // Pagination function
        function goToPage(page) {
            loadBorrowings(page, currentSize, currentSearch, currentStatus, currentSort);
        }

        // Update table content
        function updateTable(borrowings) {
            const tbody = document.getElementById('borrowingTableBody');
            tbody.innerHTML = '';

            borrowings.forEach(borrowing => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${borrowing.id || ''}</td>
                    <td>${borrowing.bookTitle || ''}</td>
                    <td>${borrowing.userName || ''}</td>
                    <td>${borrowing.borrowDate || ''}</td>
                    <td>${borrowing.returnDate || ''}</td>
                    <td>${borrowing.dueDate || ''}</td>
                    <td>
                        <a href="/borrowings/edit/${borrowing.id}" class="btn btn-sm btn-warning">Edit</a>
                        <a href="/borrowings/delete/${borrowing.id}" class="btn btn-sm btn-danger"
                           onclick="return confirm('Are you sure you want to delete this borrowing?')">Delete</a>
                        ${!borrowing.returnDate ?
                            `<button class="btn btn-success btn-sm" onclick="returnBook(${borrowing.id})">Return</button>` :
                            ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update pagination
        function updatePagination(data) {
            const container = document.getElementById('paginationContainer');
            if (data.totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = `
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        <li class="page-item ${data.currentPage === 0 ? 'disabled' : ''}">
                            <a class="page-link" href="javascript:void(0)" onclick="goToPage(${data.currentPage - 1})">Previous</a>
                        </li>
            `;

            for (let i = 0; i < data.totalPages; i++) {
                html += `
                    <li class="page-item ${i === data.currentPage ? 'active' : ''}">
                        <a class="page-link" href="javascript:void(0)" onclick="goToPage(${i})">${i + 1}</a>
                    </li>
                `;
            }

            html += `
                        <li class="page-item ${data.currentPage + 1 >= data.totalPages ? 'disabled' : ''}">
                            <a class="page-link" href="javascript:void(0)" onclick="goToPage(${data.currentPage + 1})">Next</a>
                        </li>
                    </ul>
                    <p class="text-center text-muted">Total items: ${data.totalItems}</p>
                </nav>
            `;

            container.innerHTML = html;
        }

        // Update sort indicators
        function updateSortIndicators() {
            document.querySelectorAll('[id^="sort-"]').forEach(el => el.style.display = 'none');
            if (currentSort) {
                const [field, direction] = currentSort.split(',');
                const indicator = document.getElementById(`sort-${field}-${direction}`);
                if (indicator) indicator.style.display = 'inline';
            }
        }

        // Return book function
        function returnBook(id) {
            if (!confirm('Are you sure you want to return this book?')) return;

            fetch(`/api/borrowings/${id}/return`, { method: 'PUT' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Book returned successfully!');
                        loadBorrowings(); // Reload current view
                    } else {
                        alert(data.message || 'Failed to return book.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to return book.');
                });
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
        //    document.getElementById('tableContainer').style.display = 'none';
            hideError();
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
        //    document.getElementById('tableContainer').style.display = 'block';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</div>
</html>