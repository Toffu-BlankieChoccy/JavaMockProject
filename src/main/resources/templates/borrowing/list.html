<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/base}">
<head>
    <title>Borrowing List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<div layout:fragment="content">
    <div class="container">
        <h1>Borrowings</h1>

        <!-- STEP 3A: Convert search form to prevent default submission -->
        <form id="searchForm" class="mb-3">
            <div class="row g-3">
                <div class="col-auto">
                    <input oninput="searchBorrowings()" type="text" id="searchInput" name="search" class="form-control"
                           placeholder="Search by user name or book title..."
                           th:value="${search != null ? search : ''}" aria-label="Search">
                </div>

                <div class="col-auto">
                    <!-- STEP 3C: Remove onchange form submit, add AJAX call -->
                    <select id="statusFilter" name="status" class="form-select" onchange="filterByStatus()">
                        <option value="" th:selected="${status == null}">All</option>
                        <option value="RETURNED" th:selected="${status == 'RETURNED'}">Returned</option>
                        <option value="NOT_RETURNED" th:selected="${status == 'NOT_RETURNED'}">Not Returned</option>
                        <option value="OVERDUE" th:selected="${status == 'OVERDUE'}">Overdue</option>
                    </select>
                </div>
            </div>
        </form>

        <a th:href="@{/borrowings/add}" class="btn btn-primary mb-3">Add New Borrowing</a>
        <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

        <!-- STEP 3D: Add loading indicator -->
        <div id="loadingSpinner" style="display: none;" class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- STEP 3E: Wrap table in container for easy updating -->
        <div id="tableContainer">
            <table class="table table-bordered">
                <thead>
                <tr>
                    <!-- STEP 3F: Convert sort links to AJAX calls -->
                    <th>
                        <a href="javascript:void(0)" onclick="sortTable('id')">
                            ID
                            <span id="sort-id-asc" style="display: none;">▲</span>
                            <span id="sort-id-desc" style="display: none;">▼</span>
                        </a>
                    </th>
                    <th>
                        <a href="javascript:void(0)" onclick="sortTable('book.title')">
                            Book
                            <span id="sort-book.title-asc" style="display: none;">▲</span>
                            <span id="sort-book.title-desc" style="display: none;">▼</span>
                        </a>
                    </th>
                    <th>
                        <a href="javascript:void(0)" onclick="sortTable('user.name')">
                            User
                            <span id="sort-user.name-asc" style="display: none;">▲</span>
                            <span id="sort-user.name-desc" style="display: none;">▼</span>
                        </a>
                    </th>
                    <th>
                        <a href="javascript:void(0)" onclick="sortTable('borrowDate')">
                            Borrow date
                            <span id="sort-borrowDate-asc" style="display: none;">▲</span>
                            <span id="sort-borrowDate-desc" style="display: none;">▼</span>
                        </a>
                    </th>
                    <th>
                        <a href="javascript:void(0)" onclick="sortTable('returnDate')">
                            Return date
                            <span id="sort-returnDate-asc" style="display: none;">▲</span>
                            <span id="sort-returnDate-desc" style="display: none;">▼</span>
                        </a>
                    </th>
                    <th>
                        <a href="javascript:void(0)" onclick="sortTable('dueDate')">
                            Due date
                            <span id="sort-dueDate-asc" style="display: none;">▲</span>
                            <span id="sort-dueDate-desc" style="display: none;">▼</span>
                        </a>
                    </th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="borrowingTableBody">
                <!-- Table rows will be populated by AJAX -->
                <tr th:each="borrowing : ${borrowings}">
                    <td th:text="${borrowing.id}"></td>
                    <td th:text="${borrowing.bookTitle}"></td>
                    <td th:text="${borrowing.userName}"></td>
                    <td th:text="${borrowing.borrowDate}"></td>
                    <td th:text="${borrowing.returnDate}"></td>
                    <td th:text="${borrowing.dueDate}"></td>
                    <td>
                        <a th:href="@{/borrowings/edit/{id}(id=${borrowing.id})}"
                           class="btn btn-sm btn-warning">Edit</a>
                        <a th:href="@{/borrowings/delete/{id}(id=${borrowing.id})}"
                           class="btn btn-sm btn-danger">Delete</a>
                        <a th:if="${borrowing.returnDate} == null" class="btn btn-success btn-sm"
                           th:onclick="|returnBook(${borrowing.id})|">Return</a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- STEP 3G: Convert pagination to AJAX -->
        <div id="paginationContainer">
            <!-- Pagination will be populated by AJAX -->
        </div>

        <!-- No result pane -->
        <div id="noResults" class="text-center text-muted" style="display: none;">No results found.</div>

        <!-- STEP 4: AJAX JavaScript Functions -->
        <script>
            // Global variables to track current state
            let currentPage = 0;
            let currentSize = 5;
            let currentSearch = '';
            let currentStatus = '';
            let currentSort = '';

            // STEP 4A: Initialize from Thymeleaf values
            document.addEventListener('DOMContentLoaded', function() {
                currentPage = [[${currentPage}]] || 0;
                currentSize = [[${size}]] || 5;
                currentSearch = '[[${search}]]' || '';
                currentStatus = '[[${status}]]' || '';
                currentSort = '[[${sort}]]' || '';

                // Set initial form values
                document.getElementById('searchInput').value = currentSearch;
                document.getElementById('statusFilter').value = currentStatus;

                updateSortIndicators();
                loadBorrowings();
            });

            // STEP 4B: Main function to load borrowings via AJAX
            function loadBorrowings(page = currentPage, size = currentSize, search = currentSearch, status = currentStatus, sort = currentSort) {
                // Show loading spinner
                document.getElementById('loadingSpinner').style.display = 'block';
                document.getElementById('tableContainer').style.display = 'none';

                // Build URL with parameters
                const params = new URLSearchParams();
                if (page !== null) params.append('page', page);
                if (size !== null) params.append('size', size);
                if (search) params.append('search', search);
                if (status) params.append('status', status);
                if (sort) params.append('sort', sort);

                // Make AJAX call to your API endpoint
                fetch('/api/borrowings?' + params.toString())
                    .then(response => response.json())
                    .then(data => {
                        // Update global state
                        currentPage = data.currentPage;
                        currentSize = data.size;
                        currentSearch = data.search || '';
                        currentStatus = data.status || '';
                        currentSort = data.sort || '';

                        // Update the table
                        updateTable(data.borrowings);

                        // Update pagination
                        updatePagination(data);

                        // Update sort indicators
                        updateSortIndicators();

                        // Hide loading, show table
                        document.getElementById('loadingSpinner').style.display = 'none';
                        document.getElementById('tableContainer').style.display = 'block';

                        // Show/hide no results message
                        document.getElementById('noResults').style.display = data.borrowings.length === 0 ? 'block' : 'none';
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        document.getElementById('errorMessage').textContent = 'Failed to load data';
                        document.getElementById('errorMessage').style.display = 'block';
                        document.getElementById('loadingSpinner').style.display = 'none';
                    });
            }

            // STEP 4C: Search function
            function searchBorrowings() {
                const searchValue = document.getElementById('searchInput').value;
                loadBorrowings(0, currentSize, searchValue, currentStatus, currentSort);
            }

            // STEP 4D: Filter function
            function filterByStatus() {
                const statusValue = document.getElementById('statusFilter').value;
                loadBorrowings(0, currentSize, currentSearch, statusValue, currentSort);
            }

            // STEP 4E: Sort function
            function sortTable(field) {
                let newSort = field + ',asc';

                // Toggle sort direction if same field
                if (currentSort && currentSort.startsWith(field)) {
                    if (currentSort.endsWith('asc')) {
                        newSort = field + ',desc';
                    } else {
                        newSort = field + ',asc';
                    }
                }

                loadBorrowings(currentPage, currentSize, currentSearch, currentStatus, newSort);
            }

            // STEP 4F: Pagination function
            function goToPage(page) {
                loadBorrowings(page, currentSize, currentSearch, currentStatus, currentSort);
            }

            // STEP 4G: Update table content
            function updateTable(borrowings) {
                const tbody = document.getElementById('borrowingTableBody');
                tbody.innerHTML = '';

                borrowings.forEach(borrowing => {
                    const row = `
                        <tr>
                            <td>${borrowing.id}</td>
                            <td>${borrowing.bookTitle}</td>
                            <td>${borrowing.userName}</td>
                            <td>${borrowing.borrowDate}</td>
                            <td>${borrowing.returnDate || ''}</td>
                            <td>${borrowing.dueDate || ''}</td>
                            <td>
                                <a href="/borrowings/edit/${borrowing.id}" class="btn btn-sm btn-warning">Edit</a>
                                <a href="/borrowings/delete/${borrowing.id}" class="btn btn-sm btn-danger">Delete</a>
                                ${!borrowing.returnDate ? `<button class="btn btn-success btn-sm" onclick="returnBook(${borrowing.id})">Return</button>` : ''}
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            // STEP 4H: Update pagination
            function updatePagination(data) {
                const container = document.getElementById('paginationContainer');
                if (data.totalPages <= 1) {
                    container.innerHTML = '';
                    return;
                }

                let paginationHtml = `
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            <li class="page-item ${data.currentPage === 0 ? 'disabled' : ''}">
                                <a class="page-link" href="javascript:void(0)" onclick="goToPage(${data.currentPage - 1})">Previous</a>
                            </li>
                `;

                for (let i = 0; i < data.totalPages; i++) {
                    paginationHtml += `
                        <li class="page-item ${i === data.currentPage ? 'active' : ''}">
                            <a class="page-link" href="javascript:void(0)" onclick="goToPage(${i})">${i + 1}</a>
                        </li>
                    `;
                }

                paginationHtml += `
                            <li class="page-item ${data.currentPage + 1 >= data.totalPages ? 'disabled' : ''}">
                                <a class="page-link" href="javascript:void(0)" onclick="goToPage(${data.currentPage + 1})">Next</a>
                            </li>
                        </ul>
                        <p class="text-center text-muted">Total items: ${data.totalItems}</p>
                    </nav>
                `;

                container.innerHTML = paginationHtml;
            }

            // STEP 4I: Update sort indicators
            function updateSortIndicators() {
                // Hide all sort indicators
                document.querySelectorAll('[id^="sort-"]').forEach(el => el.style.display = 'none');

                // Show current sort indicator
                if (currentSort) {
                    const [field, direction] = currentSort.split(',');
                    const indicator = document.getElementById(`sort-${field}-${direction}`);
                    if (indicator) {
                        indicator.style.display = 'inline';
                    }
                }
            }

            // STEP 4J: Enhanced return book function
            function returnBook(id) {
                if (confirm('Are you sure you want to return this book?')) {
                    fetch('/api/borrowings/' + id + '/return', {
                        method: 'PUT'
                    })
                    .then(response => response.json())
                    .then(data => {
                        alert('Book returned successfully!');
                        // Reload current page instead of full page refresh
                        loadBorrowings();
                    })
                    .catch(error => {
                        alert('Failed to return book.');
                        console.error('Error:', error);
                    });
                }
            }

            // STEP 4K: Allow Enter key to trigger search
            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById('searchInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchBorrowings();
                    }
                });
            });
        </script>
    </div>
</div>
</html>